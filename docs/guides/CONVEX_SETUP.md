# Convex Setup Guide

> Complete guide for setting up and using Convex in StackDock

---

## Quick Setup

### 1. Initialize Convex

```bash
# From repo root
npm run dev:convex
```

This will:
- Open browser to create/link Convex project
- Push your schema (`convex/schema.ts`) to Convex
- Generate API files (`convex/_generated/api.ts`)
- Keep running and watch for changes

### 2. Get Deployment URL

After `npm run dev:convex` starts, you'll see output like:

```
✓ Convex functions ready!
Watching for changes...

Convex deployment URL: https://xxx.convex.cloud
```

**Copy that URL** - you'll need it next.

### 3. Add to Environment

Create `apps/web/.env.local`:

```bash
VITE_CONVEX_URL=https://your-deployment.convex.cloud
```

**Important**: File must be named `.env.local` (with dot), not `env.local`

### 4. Restart Dev Server

```bash
# Stop current server (Ctrl+C), then:
npm run dev
```

### 5. Verify Connection

Open http://localhost:3000 and check the landing page:
- 🟢 **Green "Connected"** = Working!
- 🟡 **Yellow "Connecting..."** = Connection pending
- ⚪ **Gray "Not configured"** = Need to add URL

---

## Using Convex in Components

### Import API

```typescript
import { api } from 'convex/_generated/api'
import { useQuery, useMutation } from 'convex/react'
```

**Note**: The import path `convex/_generated/api` is aliased in `vite.config.ts` to resolve to the repo root.

### Example: Query

```typescript
import { createFileRoute } from '@tanstack/react-router'
import { useQuery } from 'convex/react'
import { api } from 'convex/_generated/api'

export const Route = createFileRoute('/my-route')({ component: MyComponent })

function MyComponent() {
  const data = useQuery(api.myModule.myQuery)
  
  if (data === undefined) {
    return <div>Loading...</div>
  }
  
  return <div>{data.message}</div>
}
```

### Example: Mutation

```typescript
import { useMutation } from 'convex/react'
import { api } from 'convex/_generated/api'

function MyComponent() {
  const createOrg = useMutation(api.organizations.create)
  
  const handleClick = async () => {
    await createOrg({ name: 'My Org' })
  }
  
  return <button onClick={handleClick}>Create</button>
}
```

---

## How It Works

### File Structure

```
stackdock/
├── convex/                    # Convex backend (repo root)
│   ├── schema.ts             # Data model
│   ├── test.ts               # Test query (no auth)
│   ├── users.ts              # User functions
│   ├── organizations.ts      # Org functions
│   └── _generated/           # Auto-generated by Convex
│       ├── api.d.ts          # TypeScript types
│       └── api.js            # Runtime API
└── apps/web/                  # TanStack Start app
    ├── src/
    │   └── routes/
    │       └── index.tsx      # Uses Convex
    └── vite.config.ts        # Has resolve alias for imports
```

### Path Resolution

Convex generates files at the repo root, but the app is in `apps/web/`. The `vite.config.ts` includes:

```typescript
resolve: {
  alias: {
    'convex/_generated': path.resolve(__dirname, '../../convex/_generated'),
  },
}
```

This allows imports like `import { api } from 'convex/_generated/api'` to work from anywhere in `apps/web/src/`.

---

## Available Functions

### Test Query (No Auth Required)

```typescript
const result = useQuery(api.test.ping)
// Returns: { status: "ok", timestamp: number, message: "Convex is connected!" }
```

### User Functions (Requires Auth)

```typescript
// Get current user
const user = useQuery(api.users.getCurrent)

// Sync from Clerk (mutation, typically called via webhook)
await syncFromClerk({ clerkId, name, email })
```

### Organization Functions (Requires Auth)

```typescript
// List user's organizations
const orgs = useQuery(api.organizations.list)

// Create organization
await create({ name: "My Org" })
```

---

## Troubleshooting

### Import Errors

**Error**: `Failed to resolve import "convex/_generated/api"`

**Solution**:
1. Restart dev server (alias changes require restart)
2. Check `convex/_generated/api.d.ts` exists
3. Verify `npm run dev:convex` has run

### Connection Errors

**Error**: Landing page shows "Not configured" or "Connecting..."

**Solution**:
1. Check `apps/web/.env.local` exists (with dot!)
2. Verify `VITE_CONVEX_URL` matches terminal output
3. Restart dev server after adding `.env.local`
4. Check `npm run dev:convex` is running

### Type Errors

**Error**: TypeScript can't find Convex types

**Solution**:
1. Run `npm run dev:convex` to generate types
2. Restart TypeScript server in VSCode: `Ctrl+Shift+P` → "TypeScript: Restart TS Server"

---

## Next Steps

- ✅ Convex is connected and working
- ⏳ Add Clerk authentication (optional)
- ⏳ Build authenticated queries using `getCurrentUser`
- ⏳ Create dashboard routes with real data

---

**For more info**: See [Convex Docs](https://docs.convex.dev)

